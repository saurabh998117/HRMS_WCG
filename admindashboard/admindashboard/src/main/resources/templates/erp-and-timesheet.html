<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Timesheet - WhiteCircle</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bs-primary: #1e3a8a; /* Navy Blue Theme */
            --bg-color: #f8fafc;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #334155;
        }

        /* --- HEADER --- */
        .top-header {
            background: white; border-bottom: 1px solid #e2e8f0;
            padding: 10px 30px;
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            height: 80px;
        }
        .btn-back-home {
            background-color: var(--bs-primary); color: white;
            border-radius: 10px; padding: 10px 24px; font-weight: 600;
            font-size: 0.85rem; text-decoration: none; display: flex; align-items: center;
            box-shadow: 0 4px 10px rgba(30, 58, 138, 0.2); transition: all 0.3s ease;
        }
        .btn-back-home:hover { background-color: #172554; transform: translateY(-2px); color: white; }

        /* --- CONTAINER --- */
        .main-container {
            max-width: 1200px; margin: 100px auto 40px; padding: 0 20px;
        }

        /* --- GLOBAL CARD STYLES (Hover & Shadow) --- */
        .hover-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            position: relative;
        }
        .hover-card:hover {
            transform: translateY(-8px); /* Lift effect */
            box-shadow: 0 15px 30px rgba(30, 58, 138, 0.15); /* Deep shadow */
            z-index: 10;
        }

        /* --- 1. ACTION CARDS (Top Row) --- */
        .action-card {
            background: white;
            /* ADDED: Navy Border */
            border: 1.5px solid var(--bs-primary);
            border-radius: 12px;
            /* CHANGED: Increased padding by 1/3 (was 20px, now 35px) */
            padding: 35px 25px;
            height: 100%;
            display: flex; align-items: center; gap: 20px;
            cursor: pointer;
        }

        .ac-icon {
            /* Increased icon size slightly */
            width: 60px; height: 60px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; flex-shrink: 0;
        }

        /* Specific Colors */
        .ac-create .ac-icon { background: #eff6ff; color: var(--bs-primary); }
        .ac-template .ac-icon { background: #fdf2f8; color: #db2777; }
        .ac-report .ac-icon { background: #f0fdf4; color: #15803d; }

        /* --- 2. CALENDAR VIEW --- */
        .calendar-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 16px;
            overflow: hidden; height: 100%;
        }
        .calendar-header {
            background: var(--bs-primary); color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Grid */
        .cal-grid-header {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 0;
            background: #f8fafc; border-bottom: 1px solid #e2e8f0;
        }
        .cal-grid-body {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 0;
        }

        .cal-head {
            text-align: center; padding: 8px; font-weight: 600; color: #64748b; font-size: 0.8rem;
        }

        /* --- CLASSY MINIMALIST CALENDAR DAYS --- */
        .cal-day {
            min-height: 90px; /* Good height for breathing room */
            padding: 12px;
            border-right: 1px solid #f1f5f9;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            background-color: white;
            transition: all 0.2s ease;
            position: relative;
        }
        .cal-day:hover { background-color: #f8fafc; }

        /* The Date Number - prominent but clean */
        .day-num {
            font-weight: 800;
            font-size: 1.15rem;
            color: #334155; /* Dark slate gray */
            margin-bottom: 8px;
            line-height: 1;
        }

        /* The Status Text container */
        .day-info {
            font-size: 0.85rem;
            font-weight: 600;
            display: flex; align-items: center;
        }

        /* Typography-based Status Styles */
        .info-present {
            color: var(--bs-primary); /* Navy theme color */
        }
        .info-absent {
            color: #dc2626; /* Professional muted red */
        }
        .info-off {
            color: #94a3b8; /* Subtle gray */
            font-weight: 500;
        }

        /* Tiny icons next to text */
        .info-icon { margin-right: 5px; font-size: 0.8rem; opacity: 0.8; }

        /* Today Highlight - Cleaner Navy accents */
        .current-day {
            background-color: #f0f5ff !important; /* Very subtle navy tint */
            box-shadow: inset 0 0 0 2px var(--bs-primary); /* Inner navy border */
            z-index: 5;
        }
        .current-day .day-num { color: var(--bs-primary); }

        /* --- RESTORED: RECENT TIMECARDS CSS --- */
        .recent-card {
            background: white; border: 1.5px solid var(--bs-primary);
            border-radius: 16px; overflow: hidden; height: 100%;
        }
        .recent-header {
            background: var(--bs-primary); color: white; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .view-all-link {
            font-size: 0.85rem; color: #bfdbfe; text-decoration: none; font-weight: 600;
        }
        .view-all-link:hover {
            color: white; text-decoration: underline; text-underline-offset: 4px;
        }
        .recent-item {
            padding: 15px 20px; border-bottom: 1px solid #f1f5f9; display: flex;
            justify-content: space-between; align-items: center; transition: background 0.2s; cursor: pointer;
        }
        .recent-item:hover { background: #f8fafc; }
        .recent-item:last-child { border-bottom: none; }

        .ri-date { font-weight: 600; color: #1e293b; font-size: 0.95rem; }
        .ri-hours { font-size: 0.8rem; color: #64748b; margin-top: 2px; }

        /* RESTORED: Status Pills */
        .status-pill { padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700; }
        .st-approved { background: #dcfce7; color: #15803d; }
        .st-submitted { background: #e0e7ff; color: #3730a3; }
        .st-draft { background: #fff7ed; color: #c2410c; }

        /* --- CLICK EFFECT FOR TOP CARDS --- */
        .action-card:active {
            transform: scale(0.98); /* Slight shrink on click */
            background-color: #f1f5f9; /* Flash color */
            border-color: #1e3a8a;
        }

        .ri-date { font-weight: 600; color: #1e293b; font-size: 0.95rem; }
        .ri-hours { font-size: 0.8rem; color: #64748b; margin-top: 2px; }

        .status-pill {
            padding: 5px 12px; border-radius: 50px; font-size: 0.75rem; font-weight: 700;
        }
        .st-approved { background: #dcfce7; color: #15803d; }
        .st-submitted { background: #e0e7ff; color: #3730a3; }
        .st-draft { background: #fff7ed; color: #c2410c; }

    </style>
</head>
<body>

<header class="top-header">
    <div class="d-flex align-items-center">
        <img src="/images/wcg-logo.jpg" alt="Logo" style="height: 60px; border-radius: 6px;">
        <span class="fw-bold ms-2 text-dark fs-4">ERP & TIMESHEET</span>
    </div>
    <a href="/employee/dashboard" class="btn-back-home">
        <i class="fas fa-arrow-left me-2"></i> Back to Home
    </a>
</header>

<div class="main-container">

    <div class="row g-4 mb-4">

        <div class="col-md-4">
            <div class="action-card hover-card ac-create" onclick="window.location.href='/employee/create-timesheet'">
                <div class="ac-icon"><i class="fas fa-plus"></i></div>
                <div>
                    <h5 class="fw-bold text-dark mb-1">Create Timesheet</h5>
                    <small class="text-muted">Log hours for this week</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="action-card hover-card ac-template">
                <div class="ac-icon"><i class="fas fa-copy"></i></div>
                <div>
                    <h5 class="fw-bold text-dark mb-1">Use Template</h5>
                    <small class="text-muted">Pre-fill from projects</small>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="action-card hover-card ac-report" onclick="window.location.href='/employee/my-timesheets'">
                <div class="ac-icon"><i class="fas fa-file-invoice"></i></div>
                <div>
                    <h5 class="fw-bold text-dark mb-1">Timesheet Report</h5>
                    <small class="text-muted">Monthly summary</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">

        <div class="col-lg-8">
            <div class="calendar-card hover-card">
                <div class="calendar-header">
                    <div class="fw-bold" id="monthYearDisplay" style="font-size: 1.1rem;">
                        <i class="fas fa-calendar-alt me-2"></i> January 2026
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-light border-0" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                        <button class="btn btn-sm btn-outline-light border-0" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        <button class="btn btn-sm btn-light text-primary fw-bold ms-2" onclick="goToToday()" style="font-size: 0.75rem;">Today</button>
                    </div>
                </div>

                <div class="cal-grid-header">
                    <div class="cal-head">Sun</div>
                    <div class="cal-head">Mon</div>
                    <div class="cal-head">Tue</div>
                    <div class="cal-head">Wed</div>
                    <div class="cal-head">Thu</div>
                    <div class="cal-head">Fri</div>
                    <div class="cal-head">Sat</div>
                </div>

                <div class="cal-grid-body" id="calendarGrid">
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow-sm border-0 h-100" style="border-radius: 12px; overflow: hidden;">
                <div class="p-3 d-flex justify-content-between align-items-center" style="background-color: var(--bs-primary);">
                    <h6 class="m-0 fw-bold text-white"><i class="fas fa-history me-2"></i>Recent Timesheets</h6>
                </div>

                <div class="card-body p-0" id="recentTimecardsContainer">
                    <div class="p-5 text-center text-muted">
                        <div class="spinner-border spinner-border-sm text-primary mb-2" role="status"></div>
                        <br><small>Loading timesheets...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentDate = new Date(); // Start with today
    let timesheetDataMap = {}; // Stores { "2026-02-23": 8.5 }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', fetchHubData);

    // 1. Fetch ALL data from our new API once
    async function fetchHubData() {
        try {
            const response = await fetch('/api/weekly-timesheet/my-timesheets');

            if (response.ok) {
                const timesheets = await response.json();

                // A. Render the Recent Timecards panel immediately
                renderRecentTimecards(timesheets);

                // B. Process the data for the Calendar
                timesheetDataMap = {}; // Reset map

                timesheets.forEach(ts => {
                    if (!ts.entries || ts.entries.length === 0) return;

                    const startDate = new Date(ts.weekStartDate);
                    let dailySums = [0, 0, 0, 0, 0, 0, 0]; // Sun to Sat

                    // Add up the hours from every row for that week
                    ts.entries.forEach(entry => {
                        dailySums[0] += entry.sunHours || 0;
                        dailySums[1] += entry.monHours || 0;
                        dailySums[2] += entry.tueHours || 0;
                        dailySums[3] += entry.wedHours || 0;
                        dailySums[4] += entry.thuHours || 0;
                        dailySums[5] += entry.friHours || 0;
                        dailySums[6] += entry.satHours || 0;
                    });

                    // Map those sums to actual calendar dates (YYYY-MM-DD)
                    for (let i = 0; i < 7; i++) {
                        if (dailySums[i] > 0) {
                            let currentLoopDate = new Date(startDate);
                            currentLoopDate.setDate(startDate.getDate() + i);

                            // Format strictly as YYYY-MM-DD
                            let dateString = currentLoopDate.getFullYear() + '-' +
                                             String(currentLoopDate.getMonth() + 1).padStart(2, '0') + '-' +
                                             String(currentLoopDate.getDate()).padStart(2, '0');

                            // Save the hours to our map
                            timesheetDataMap[dateString] = dailySums[i];
                        }
                    }
                });
            } else {
                console.error("API Error. Status:", response.status);
                document.getElementById('recentTimecardsContainer').innerHTML = '<div class="p-4 text-center text-danger">Failed to load data.</div>';
            }
        } catch (error) {
            console.error("Error fetching timesheets:", error);
            document.getElementById('recentTimecardsContainer').innerHTML = '<div class="p-4 text-center text-danger">Network Error: Failed to load data.</div>';
        } finally {
            // C. Render the calendar regardless of success or failure!
            renderCalendar();
        }
    }

    // 2. Render the Calendar
    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        document.getElementById('monthYearDisplay').innerHTML = `<i class="fas fa-calendar-alt me-2"></i> ${monthNames[month]} ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const totalDays = lastDay.getDate();
        const startDayIndex = firstDay.getDay();

        // Reset time to midnight for accurate "past vs future" checking
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        let html = '';

        // Empty cells for days before the 1st
        for (let i = 0; i < startDayIndex; i++) {
            html += `<div class="cal-day bg-light"></div>`;
        }

        // Days 1 to Total
        for (let day = 1; day <= totalDays; day++) {
            const currentLoopDate = new Date(year, month, day);
            const isToday = (currentLoopDate.getTime() === today.getTime());
            const dayClass = isToday ? 'cal-day current-day' : 'cal-day';
            const dayOfWeek = currentLoopDate.getDay();

            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            // Default empty content
            let dayContent = `<span class="day-num">${day}</span>`;

            if (dayOfWeek === 0 || dayOfWeek === 6) {
                // Saturday & Sunday
                dayContent += `<div class="day-info info-off">Off</div>`;
            } else if (currentLoopDate <= today) {
                // Past or Today (Weekdays)
                const loggedHours = timesheetDataMap[dateString];

                if (loggedHours !== undefined && loggedHours > 0) {
                    // Use theme color (navy) for logged hours with a subtle clock icon
                    dayContent += `<div class="day-info info-present"><i class="fas fa-clock info-icon"></i>${loggedHours}h</div>`;
                } else {
                    // absent marker
                    dayContent += `<div class="day-info info-absent">Absent</div>`;
                }
            }
            // Future weekdays just show the date number

            html += `
                <div class="${dayClass}">
                    ${dayContent}
                </div>
            `;
        }

        document.getElementById('calendarGrid').innerHTML = html;
    }

    // 3. Render Recent Timecards Panel
    function renderRecentTimecards(timesheets) {
        const container = document.getElementById('recentTimecardsContainer');
        container.innerHTML = '';

        if (!timesheets || timesheets.length === 0) {
            container.innerHTML = '<div class="p-4 text-center text-muted"><i class="fas fa-folder-open mb-2 fs-3 opacity-50"></i><br>No recent timesheets found.</div>';
            return;
        }

        const recentFour = timesheets.slice(0, 4);

        recentFour.forEach(ts => {
            const startDate = new Date(ts.weekStartDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });
            const endDate = new Date(ts.weekEndDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' });

            // FIXED TYPO HERE!
            let badgeClass = 'bg-secondary';
            if (ts.status === 'DRAFT') badgeClass = 'bg-warning text-dark';
            if (ts.status === 'SUBMITTED') badgeClass = 'bg-primary text-white';
            if (ts.status === 'APPROVED') badgeClass = 'bg-success text-white';
            if (ts.status === 'REJECTED') badgeClass = 'bg-danger text-white';

            const html = `
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center" style="transition: background-color 0.2s cursor: pointer;" onmouseover="this.style.backgroundColor='#f8fafc'" onmouseout="this.style.backgroundColor='transparent'">
                    <div>
                        <h6 class="mb-1 fw-bold text-dark">${startDate} - ${endDate}</h6>
                        <small class="text-muted"><i class="fas fa-clock me-1 text-primary"></i>Total: ${ts.totalWeekHours || 0} Hours</small>
                    </div>
                    <div>
                        <span class="badge ${badgeClass} rounded-pill px-3 py-2 shadow-sm">${ts.status}</span>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });
    }

    // 4. Navigation Controls
    function changeMonth(step) {
        const today = new Date();

        // Calculate what the new month and year WOULD be if we let them click it
        const targetDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + step, 1);

        // Check if the target month/year is in the future
        if (targetDate.getFullYear() > today.getFullYear() ||
           (targetDate.getFullYear() === today.getFullYear() && targetDate.getMonth() > today.getMonth())) {

            alert("Company Policy: You cannot view or draft timesheets for future months.");
            return; // Instantly stops the code so the calendar does NOT change!
        }
        // If it's a past or current month, allow the change
        currentDate.setMonth(currentDate.getMonth() + step);
        renderCalendar();
    }

    function goToToday() {
        currentDate = new Date();
        renderCalendar();
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>