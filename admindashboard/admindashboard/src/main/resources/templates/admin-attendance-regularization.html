<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Attendance Regularization | Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #1a237e;
            --bg-light: #f4f6f9;
        }
        body { background-color: var(--bg-light); font-family: 'Segoe UI', sans-serif; }

        /* --- 1. UPDATED NAVBAR (Matches Timesheet Page) --- */
        .navbar-custom {
            background-color: var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding-top: 25px;    /* Increased Height */
            padding-bottom: 25px; /* Increased Height */
        }

        /* Layout Grid */
        .req-card {
            background: white;
            border-radius: 12px;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            overflow: hidden;
            margin-bottom: 20px;
            display: flex;
            flex-direction: row;
        }
        .req-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(0,0,0,0.08); }

        /* Left Side: Date Box */
        .date-box {
            background-color: #e8eaf6;
            color: var(--primary);
            width: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #eee;
            padding: 15px;
        }
        .date-day { font-size: 1.8rem; font-weight: 800; line-height: 1; }
        .date-month { font-size: 0.85rem; text-transform: uppercase; font-weight: 600; letter-spacing: 1px; }

        /* Middle: Content */
        .card-content { padding: 20px; flex-grow: 1; }

        /* Right Side: Actions */
        .action-box {
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 15px;
            border-left: 1px solid #f0f0f0;
            background: #fafafa;
            width: 140px;
            gap: 10px;
        }

        /* Badges */
        .badge-type { padding: 5px 10px; border-radius: 6px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .type-late { background-color: #fff3cd; color: #856404; }
        .type-id { background-color: #cff4fc; color: #055160; }
        .type-wfh { background-color: #e2e3e5; color: #383d41; }

        /* Buttons */
        .btn-action { width: 100%; border-radius: 6px; font-weight: 600; font-size: 0.85rem; text-align: center; padding: 8px 0; border: none; transition: 0.2s; }
        .btn-approve { background-color: #d1e7dd; color: #0f5132; }
        .btn-approve:hover { background-color: #198754; color: white; }
        .btn-reject { background-color: #f8d7da; color: #842029; }
        .btn-reject:hover { background-color: #dc3545; color: white; }

        /* Tabs */
        .nav-pills .nav-link {
            color: #666; font-weight: 600; border-radius: 30px; padding: 8px 25px;
            background: white; border: 1px solid #eee; margin-right: 10px;
        }
        .nav-pills .nav-link.active { background-color: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<nav class="navbar navbar-custom navbar-dark mb-4">
    <div class="container">
        <span class="navbar-brand fw-bold fs-4">
            <i class="fas fa-user-clock me-2"></i> Regularization Approvals
        </span>

        <a href="/admin/dashboard" class="btn btn-outline-light btn-sm px-4 rounded-0 fw-bold">
            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
        </a>
    </div>
</nav>

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="fw-bold mb-1 text-dark">Employee Requests</h4>
            <p class="text-muted small mb-0">Manage forgot ID, late marks, and WFH requests</p>
        </div>
        <ul class="nav nav-pills">
            <li class="nav-item"><a class="nav-link active" href="#" onclick="loadRequests('Pending', this)">Pending</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="loadRequests('Approved', this)">Approved</a></li>
            <li class="nav-item"><a class="nav-link" href="#" onclick="loadRequests('Rejected', this)">Rejected</a></li>
        </ul>
    </div>

    <div id="requestContainer" class="row">
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-2 text-muted">Loading...</p>
        </div>
    </div>

</div>

<script>
    document.addEventListener("DOMContentLoaded", () => loadRequests('Pending', document.querySelector('.nav-link.active')));

    function loadRequests(status, btnElement) {
        // 1. Update Tabs
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');

        const container = document.getElementById('requestContainer');
        container.innerHTML = '<div class="col-12 text-center py-5"><div class="spinner-border text-primary"></div></div>';

        // 2. Fetch Data
        fetch(`/api/admin/regularization/list?status=${status}`)
            .then(res => res.json())
            .then(data => {
                container.innerHTML = '';

                if(data.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 text-center py-5">
                            <i class="fas fa-clipboard-check fa-3x text-muted mb-3 opacity-25"></i>
                            <h5 class="text-muted">No ${status.toLowerCase()} requests found</h5>
                        </div>`;
                    return;
                }

                data.forEach(req => {
                    const d = new Date(req.date);
                    const day = d.getDate();
                    const month = d.toLocaleString('default', { month: 'short' });

                    let typeClass = 'type-wfh';
                    let icon = 'fa-laptop-house';
                    if(req.type.toLowerCase().includes('late')) { typeClass = 'type-late'; icon = 'fa-clock'; }
                    if(req.type.toLowerCase().includes('id')) { typeClass = 'type-id'; icon = 'fa-id-card'; }

                    const html = `
                    <div class="col-lg-6">
                        <div class="req-card">
                            <div class="date-box">
                                <span class="date-day">${day}</span>
                                <span class="date-month">${month}</span>
                            </div>
                            <div class="card-content">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="fw-bold text-dark mb-0">${req.user ? req.user.fullName : 'Unknown User'}</h5>
                                    <span class="badge-type ${typeClass}"><i class="fas ${icon} me-1"></i>${req.type}</span>
                                </div>
                                <p class="text-muted small mb-0" style="line-height: 1.5;">
                                    <i class="fas fa-quote-left text-primary opacity-25 me-1"></i>
                                    ${req.reason}
                                </p>
                                ${status !== 'Pending' && req.hrComments ? `<div class="mt-2 small text-danger fw-bold">HR Note: ${req.hrComments}</div>` : ''}
                            </div>
                            <div class="action-box">
                                ${status === 'Pending' ? `
                                    <button class="btn-action btn-approve" onclick="updateStatus(${req.id}, 'Approved')">
                                        <i class="fas fa-check me-1"></i> Approve
                                    </button>
                                    <button class="btn-action btn-reject" onclick="updateStatus(${req.id}, 'Rejected')">
                                        <i class="fas fa-times me-1"></i> Reject
                                    </button>
                                ` : `
                                    <div class="text-center">
                                        <span class="badge ${status === 'Approved' ? 'bg-success' : 'bg-danger'} px-3 py-2 rounded-pill">${status}</span>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>`;

                    container.innerHTML += html;
                });
            })
            .catch(err => {
                console.error(err);
                container.innerHTML = `<div class="alert alert-danger">Error loading data</div>`;
            });
    }

    function updateStatus(id, newStatus) {
        if (!confirm(`Are you sure you want to ${newStatus}?`)) return;

        let url = `/api/admin/regularization/${id}/${newStatus}`;
        if (newStatus === 'Rejected') {
            const reason = prompt("Reason for rejection:");
            if (!reason) return;
            url += `?comments=${encodeURIComponent(reason)}`;
        }

        fetch(url, { method: 'POST' })
            .then(res => {
                if(res.ok) {
                    loadRequests('Pending', document.querySelector('.nav-link.active'));
                } else {
                    alert("Something went wrong.");
                }
            });
    }
</script>

</body>
</html>