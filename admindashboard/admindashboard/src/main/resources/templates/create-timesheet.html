<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Timecard - WhiteCircle</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bs-primary: #1e3a8a; /* Navy Blue Theme */
            --bs-primary-hover: #172554;
            --bg-color: #f8fafc;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #334155;
            padding-top: 110px; /* INCREASED from 80px */
            padding-bottom: 40px;
        }

        /* --- HEADER --- */
        .top-nav-bar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
            background: white;
            height: 90px; /* INCREASED from 70px */
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 30px; border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .brand-section {
            display: flex; align-items: center; color: var(--bs-primary);
            font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn-back {
            background: white; color: var(--bs-primary);
            padding: 6px 16px; border-radius: 10px; font-weight: 600; font-size: 0.85rem;
            text-decoration: none; border: 1px solid var(--bs-primary); transition: all 0.2s;
        }
        .btn-back:hover { background: var(--bs-primary); color: white; }

        /* --- CARDS & PANELS --- */
        .content-panel {
            background: white; border-radius: 10px; border: 1px solid var(--border-color);
            padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.01);
        }

        /* --- TOP INFO SECTION --- */
        .info-label { font-size: 0.95rem; color: #64748b; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; display: block; }
        .info-value { font-size: 1.05rem; font-weight: 700; color: #0f172a; }

        .date-picker-group { display: flex; align-items: center; gap: 12px; }
        .form-control-date {
            border: 1px solid var(--bs-primary); border-radius: 6px; padding: 8px 12px;
            color: #0f172a; font-weight: 600; font-size: 0.95rem; background: #f8fafc;
        }
        .form-control-date:focus { outline: none; background: white; box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.2); }

        /* --- STRICT ENTERPRISE GRID (Navy Borders) --- */
        .table-wrapper {
            /* Outer border of the table */
            border: 2px solid var(--bs-primary);
            border-radius: 4px;
            overflow: hidden;
            background: white;
        }
        .table-responsive { overflow-x: auto; }
        .timecard-table { margin-bottom: 0; min-width: 1700px; border-collapse: collapse; }

        /* Strict cell borders for rows and columns */
        .timecard-table th, .timecard-table td {
            border: 1px solid var(--bs-primary) !important;
        }

        .timecard-table th {
            background-color: #f0f5fa; /* Very light navy tint */
            color: var(--bs-primary); font-size: 0.75rem; text-transform: uppercase;
            font-weight: 700; text-align: center; vertical-align: middle; padding: 12px 10px;
            letter-spacing: 0.5px; white-space: nowrap;
        }

        .timecard-table td {
            vertical-align: top;
            padding: 8px; /* Slightly tighter padding to let inputs fill the space */
            background-color: white;
        }

        /* Column Widths */
        .col-dropdown { min-width: 200px; }
        .col-day { min-width: 95px; text-align: center; }
        .col-total { min-width: 90px; text-align: center; font-weight: 700; background-color: #f0f5fa !important; }
        .col-details { min-width: 300px; }
        .col-action { min-width: 50px; text-align: center; vertical-align: middle !important; }

        /* Inputs - Designed to fit inside the strict grid */
        .grid-select, .grid-input-hours, .grid-input-text {
            width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 8px;
            font-size: 0.9rem; color: #334155; background-color: #fefefe; transition: all 0.2s;
        }
        .grid-select { cursor: pointer; color: #0f172a; font-weight: 600; }
        .grid-input-hours { text-align: center; font-weight: 700; color: var(--bs-primary); font-size: 1rem; }
        .grid-input-text { resize: vertical; min-height: 40px; line-height: 1.4; }

        .grid-select:focus, .grid-input-hours:focus, .grid-input-text:focus {
            border-color: var(--bs-primary); outline: none; background-color: white; box-shadow: 0 0 0 2px rgba(30, 58, 138, 0.15);
        }

        /* Total Row */
        .row-totals td {
            background-color: #f0f5fa !important; color: var(--bs-primary); font-weight: 800;
            padding: 14px 10px; border-top: 2px solid var(--bs-primary) !important; vertical-align: middle;
        }

        /* --- BUTTONS --- */
        .btn-navy { background-color: var(--bs-primary); color: white; font-weight: 600; border: none; }
        .btn-navy:hover { background-color: var(--bs-primary-hover); color: white; transform: translateY(-1px); }
        .btn-outline-navy { border: 1.5px solid var(--bs-primary); color: var(--bs-primary); font-weight: 600; background: transparent; }
        .btn-outline-navy:hover { background-color: #eff6ff; color: var(--bs-primary); }

        .btn-grid-action { padding: 8px 18px; font-size: 0.9rem; border-radius: 6px; transition: all 0.2s; }

        .btn-delete-row {
            color: #dc2626; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 4px;
            width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;
            font-size: 1rem; transition: all 0.2s; cursor: pointer; margin: 0 auto;
        }
        .btn-delete-row:hover { color: white; background: #dc2626; border-color: #dc2626; }

        /* --- TABLE READABILITY ENHANCEMENTS --- */
        /* 1. Make all rows vertically wider (Breathing room) */
        .timecard-table th,
        .timecard-table td {
            padding: 18px 12px !important;
            vertical-align: middle;
        }
        /* 2. Visually separate the Header */
        .timecard-table thead tr {
            background-color: #f1f5f9 !important; /* Light slate background */
            border-bottom: 2px solid #cbd5e1 !important; /* Thicker separation line */
        }
        /* 3. Visually separate the Footer (Daily Totals) */
        .timecard-table tfoot tr {
            background-color: #f8fafc !important; /* Very subtle slate background */
            border-top: 2px solid #cbd5e1 !important; /* Thicker separation line */
        }
        /* 4. Optional: Subtle hover effect for the main data rows */
        .timecard-table tbody tr:hover {
            background-color: #fdfdfd;
        }

        /*  Increase the main header text (PROJECT, TASK, SUN, MON, etc.) */
        .timecard-table thead th {
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        /*  Increase the smaller date text (22 Feb, 23 Feb, etc.) */
        .timecard-table thead th small {
            font-size: 0.8rem !important; /* Overrides Bootstrap's default <small> size */
        }

        /* --- INTERACTIVE UI EFFECTS --- */

        /* 1. Button Click Animations */
        .btn, .btn-grid-action {
            transition: all 0.15s ease-in-out;
        }
        .btn:active, .btn-grid-action:active {
            transform: scale(0.95); /* Makes the button physically "press" down */
        }

        /* 2. Input Hover & Focus Effects */
        .form-control, .form-select {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .form-control:hover, .form-select:hover {
            border-color: var(--bs-primary) !important; /* Highlights blue on hover */
        }
        .form-control:focus, .form-select:focus {
            border-color: var(--bs-primary) !important;
            box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.15) !important; /* Adds a soft blue glow when typing */
            background-color: #fff !important;
        }

        /* 3. Outline Button Hover Fixes */
        .btn-outline-secondary:hover {
            background-color: #6c757d !important;
            color: #ffffff !important; /* Forces text to pure white */
        }
        .btn-outline-navy {
            border-color: var(--bs-primary);
            color: var(--bs-primary);
        }
        .btn-outline-navy:hover {
            background-color: var(--bs-primary) !important;
            color: #ffffff !important; /* Forces text to pure white */
        }
    </style>
</head>
<body>

<nav class="top-nav-bar">
    <div class="brand-section d-flex align-items-center">
        <img src="/images/wcg-logo.jpg" alt="Logo" style="height: 55px; border-radius: 6px;" class="me-3">
        <span class="fw-bold text-dark fs-4" style="letter-spacing: 0;">CREATE TIMESHEET</span>
    </div>
    <a href="/employee/erp-timesheet" class="btn btn-navy px-4 py-2 fw-bold shadow-sm">
        <i class="fas fa-arrow-left me-2"></i>Back to ERP Hub
    </a>
</nav>

<div class="container-fluid px-4" style="margin-top: 20px; max-width: 1800px;">

    <div class="content-panel mb-4" style="border: 2px solid var(--bs-primary);">
        <div class="row align-items-center">
            <div class="col-md-3 border-end">
                <span class="info-label">Employee Name</span>
                <div class="info-value" id="displayEmpName">Loading...</div>
            </div>
            <div class="col-md-3 border-end ps-4">
                <span class="info-label">Employee ID</span>
                <div class="info-value" id="displayEmpId">Loading...</div>
            </div>
            <div class="col-md-6 ps-4">
                <span class="info-label">Timesheet Period (Sun - Sat)</span>
                <div class="date-picker-group">
                    <input type="date" class="form-control-date" id="startDate" max="9999-12-31" value="2026-02-15">
                    <span class="fw-bold text-muted px-1">to</span>
                    <input type="date" class="form-control-date" id="endDate" max="9999-12-31" value="2026-02-21">
                    <button id="loadWeekBtn" class="btn btn-navy btn-sm px-4 py-2 ms-2 rounded-2 shadow-sm">Load Week</button>
                </div>
            </div>
        </div>
    </div>

    <div class="content-panel p-0 overflow-hidden mb-5 bg-white shadow-sm" style="border: 1px solid #e2e8f0; border-radius: 12px;">

        <div class="py-3 px-4 d-flex justify-content-between align-items-center" style="background-color: var(--bs-primary);">
            <h6 class="fw-bold text-white m-0" style="font-size: 1.1rem;">Weekly Task Breakdown</h6>
        </div>

        <div class="table-responsive border-bottom">
            <table class="table timecard-table mb-0">
                <thead>
                <tr>
                    <th class="col-dropdown">Project</th>
                    <th class="col-dropdown">Task</th>
                    <th class="col-dropdown">Type</th>
                    <th class="col-day">Sun<br><small class="text-secondary fw-bold text-capitalize">15 Feb</small></th>
                    <th class="col-day">Mon<br><small class="text-secondary fw-bold text-capitalize">16 Feb</small></th>
                    <th class="col-day">Tue<br><small class="text-secondary fw-bold text-capitalize">17 Feb</small></th>
                    <th class="col-day">Wed<br><small class="text-secondary fw-bold text-capitalize">18 Feb</small></th>
                    <th class="col-day">Thu<br><small class="text-secondary fw-bold text-capitalize">19 Feb</small></th>
                    <th class="col-day">Fri<br><small class="text-secondary fw-bold text-capitalize">20 Feb</small></th>
                    <th class="col-day">Sat<br><small class="text-secondary fw-bold text-capitalize">21 Feb</small></th>
                    <th class="col-total">Total</th>
                    <th class="col-details">Comments / Details</th>
                    <th class="col-action"><i class="fas fa-trash"></i></th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>
                        <select class="grid-select">
                            <option>Select Project...</option>
                            <option selected>HRMS Internal Module</option>
                            <option>Client Alpha Website</option>
                        </select>
                    </td>
                    <td>
                        <select class="grid-select">
                            <option>Select Task...</option>
                            <option selected>Frontend Development</option>
                            <option>Backend API Setup</option>
                            <option>Testing & Debugging</option>
                        </select>
                    </td>
                    <td>
                        <select class="grid-select">
                            <option selected>Billable</option>
                            <option>Non-Billable</option>
                            <option>Leave</option>
                        </select>
                    </td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="0"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="8"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="8"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="8"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="8"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="8"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="0"></td>
                    <td class="col-total text-primary fs-5 align-middle">40.0</td>
                    <td><textarea class="grid-input-text" rows="2" placeholder="Add specific details about the work completed..."></textarea></td>
                    <td><button class="btn-delete-row" title="Delete Row"><i class="fas fa-times"></i></button></td>
                </tr>

                <tr>
                    <td>
                        <select class="grid-select">
                            <option>Select Project...</option>
                            <option>HRMS Internal Module</option>
                            <option selected>Company Meetings</option>
                        </select>
                    </td>
                    <td>
                        <select class="grid-select">
                            <option>Select Task...</option>
                            <option selected>Sprint Planning</option>
                            <option>Client Sync</option>
                        </select>
                    </td>
                    <td>
                        <select class="grid-select">
                            <option>Billable</option>
                            <option selected>Non-Billable</option>
                            <option>Leave </option>
                        </select>
                    </td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="0"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="1"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="0"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="1.5"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="0"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="0"></td>
                    <td><input type="number" class="grid-input-hours" min="0" max="24" step="0.5" value="0"></td>
                    <td class="col-total text-primary fs-5 align-middle">2.5</td>
                    <td><textarea class="grid-input-text" rows="2" placeholder="Weekly syncs with the team."></textarea></td>
                    <td><button class="btn-delete-row" title="Delete Row"><i class="fas fa-times"></i></button></td>
                </tr>
                </tbody>
                <tfoot>
                <tr class="row-totals">
                    <td colspan="3" class="text-end pe-4 text-uppercase fs-6">Daily Totals:</td>
                    <td class="text-center total-val fs-6">0.0</td>
                    <td class="text-center total-val fs-6">9.0</td>
                    <td class="text-center total-val fs-6">8.0</td>
                    <td class="text-center total-val fs-6">9.5</td>
                    <td class="text-center total-val fs-6">8.0</td>
                    <td class="text-center total-val fs-6">8.0</td>
                    <td class="text-center total-val fs-6">0.0</td>
                    <td class="text-center total-val fs-4">42.5</td>
                    <td colspan="2" class="fw-normal ps-3">Total Logged Hours</td>
                </tr>
                </tfoot>
            </table>
        </div>

        <div class="table-responsive mb-3">
            <table class="table timecard-table mb-0">
            </table>
        </div>

        <div class="p-3 bg-white border-top border-bottom d-flex justify-content-between align-items-center flex-wrap gap-3">

            <div class="d-flex align-items-center gap-3 flex-wrap">
                <button class="btn btn-navy btn-grid-action fw-bold"><i class="fas fa-plus me-2"></i> Add Row</button>
                <button class="btn btn-outline-navy btn-grid-action bg-white fw-bold"><i class="fas fa-calculator me-2"></i> Recalculate</button>

                <div class="vr mx-1 text-secondary" style="width: 2px; opacity: 0.2;"></div>

                <select id="templateSelect" class="form-select border-secondary shadow-sm" style="width: auto; cursor: pointer;">
                    <option selected disabled>Select Template...</option>
                    <option value="1">Standard Dev Week</option>
                    <option value="2">QA & Testing</option>
                </select>
                <button id="btnApplyTemplate" class="btn btn-outline-secondary bg-white text-dark shadow-sm">
                    <i class="fas fa-magic me-2"></i> Apply Template
                </button>
            </div>
        </div>

        <div class="p-4" style="background-color: #f8fafc;">
            <div class="d-flex flex-column gap-4">

                <div>
                    <label class="fw-bolder text-dark mb-2 small" style="letter-spacing: 0.5px;"><i class="fas fa-comment-dots text-primary me-2"></i> ADDITIONAL DETAILS & CONTEXT</label>
                    <textarea id="overallComments" class="form-control border-secondary shadow-sm" rows="3" placeholder="Provide any overall summary, blockers, or context for this week's timesheet..."></textarea>
                </div>

                <div style="max-width: 300px;">
                    <label class="fw-bolder text-dark mb-2 small" style="letter-spacing: 0.5px;"><i class="fas fa-fingerprint text-primary me-2"></i> ACCESS CONTROL HOURS</label>
                    <div class="input-group shadow-sm">
                        <input type="number" class="form-control bg-white border-secondary" placeholder="0.0" step="0.5">
                        <span class="input-group-text bg-light text-muted fw-bold border-secondary">hrs</span>
                    </div>
                    <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">(Biometric / Door Swipe log)</small>
                </div>

                <div style="max-width: 400px;">
                    <label class="fw-bolder text-dark mb-2 small" style="letter-spacing: 0.5px;"><i class="fas fa-paperclip text-primary me-2"></i> ATTACHMENTS (FUTURE SCOPE)</label>
                    <div class="p-2 bg-white rounded border border-secondary d-flex flex-column justify-content-center shadow-sm" style="transition: border-color 0.2s ease;">
                        <input class="form-control form-control-sm text-muted" type="file" disabled title="Attachment feature coming soon">
                    </div>
                </div>
            </div>
        </div>

        <div class="p-4 border-top bg-white d-flex justify-content-end align-items-center gap-3" style="border-bottom-left-radius: 8px; border-bottom-right-radius: 8px;">
            <button id="btnCancel" type="button" onclick="window.location.href='/employee/erp-timesheet'" class="btn btn-outline-secondary px-4 py-2 fw-bold shadow-sm"> Cancel </button>
            <button id="btnSaveDraft" type="button" class="btn btn-outline-navy px-4 py-2 fw-bold shadow-sm"> Save Draft </button>
            <button id="btnSubmit" type="button" class="btn btn-navy px-4 py-2 fw-bold shadow rounded-pill">Submit to Admin <i class="fas fa-paper-plane ms-2"></i></button>
        </div>
    </div>
</div>
<script>
    // --- MASTER TIMESHEET JAVASCRIPT ENGINE ---

    document.addEventListener('DOMContentLoaded', function() {

        // 1. Fetch user details immediately on load
        fetchCurrentUserDetails();

        const btnSaveDraft = document.getElementById('btnSaveDraft');
        const btnSubmit = document.getElementById('btnSubmit');
        const addRowBtn = document.querySelector('.fa-plus').closest('button');
        const recalcBtn = document.querySelector('.fa-calculator').closest('button');

        if(btnSaveDraft) btnSaveDraft.addEventListener('click', () => submitTimesheet('DRAFT'));
        if(btnSubmit) btnSubmit.addEventListener('click', () => submitTimesheet('SUBMITTED'));
        if(addRowBtn) addRowBtn.addEventListener('click', addRow);

        if(recalcBtn) {
            recalcBtn.addEventListener('click', function() {
                calculateTotals();
                document.querySelectorAll('.col-total, .total-val').forEach(cell => {
                    cell.style.transition = 'none';
                    cell.style.backgroundColor = '#dcfce7';
                    setTimeout(() => {
                        cell.style.transition = 'background-color 0.8s ease';
                        cell.style.backgroundColor = '';
                    }, 200);
                });
            });
        }
        setupDateSelectors();

        // 2. CHECK FOR EXISTING DATA ON LOAD!
        const startDateInput = document.getElementById('startDate');
        if (startDateInput && startDateInput.value) {
            loadTimesheetForWeek(startDateInput.value);
        } else {
            resetTimesheetBoard();
        }
    });

    // --- FETCH LOGGED IN USER DETAILS ---
    function fetchCurrentUserDetails() {
        fetch('/api/weekly-timesheet/current-user')
            .then(response => {
                if (!response.ok) throw new Error("Session expired or user not logged in");
                return response.json();
            })
            .then(data => {
                const nameEl = document.getElementById('displayEmpName');
                const idEl = document.getElementById('displayEmpId');
                if (nameEl) nameEl.textContent = data.employeeName || 'Unknown Employee';
                if (idEl) idEl.textContent = data.employeeId || 'N/A';
            })
            .catch(err => {
                console.error("Error fetching user details:", err);
                const nameEl = document.getElementById('displayEmpName');
                const idEl = document.getElementById('displayEmpId');
                if (nameEl) nameEl.textContent = 'Not Logged In';
                if (idEl) idEl.textContent = 'N/A';
            });
    }

    // --- FETCH AND POPULATE LOGIC ---
    function loadTimesheetForWeek(startDateStr) {
        fetch(`/api/weekly-timesheet/week?startDate=${startDateStr}`)
        .then(response => {
            if (response.status === 204) {
                // No draft exists for this week -> wipe board clean
                resetTimesheetBoard();
                updateStatusBadge('New', 'bg-secondary text-white');
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (data) populateTimesheetBoard(data);
        })
        .catch(error => console.error("Error loading timesheet:", error));
    }

    function populateTimesheetBoard(data) {
        if (data.status === 'DRAFT') updateStatusBadge(data.status, 'bg-warning text-dark border-warning');
        else if (data.status === 'SUBMITTED') updateStatusBadge(data.status, 'bg-primary text-white');
        else if (data.status === 'APPROVED') updateStatusBadge(data.status, 'bg-success text-white');
        else updateStatusBadge(data.status, 'bg-secondary text-white');

        const commentsArea = document.getElementById('overallComments');
        if (commentsArea) commentsArea.value = data.overallComments || '';

        const tbody = document.querySelector('.timecard-table tbody');
        const templateRow = tbody.querySelector('tr').cloneNode(true);
        tbody.innerHTML = '';

        if (data.entries && data.entries.length > 0) {
            data.entries.forEach(entry => {
                const newRow = templateRow.cloneNode(true);

                const selects = newRow.querySelectorAll('select');
                if (selects.length >= 3) {
                    selects[0].selectedIndex = entry.projectId || 0;
                    selects[1].selectedIndex = entry.taskId || 0;
                    selects[2].value = entry.type || "Billable";
                }

                const inputs = newRow.querySelectorAll('.grid-input-hours');
                inputs[0].value = entry.sunHours || 0;
                inputs[1].value = entry.monHours || 0;
                inputs[2].value = entry.tueHours || 0;
                inputs[3].value = entry.wedHours || 0;
                inputs[4].value = entry.thuHours || 0;
                inputs[5].value = entry.friHours || 0;
                inputs[6].value = entry.satHours || 0;

                const details = newRow.querySelector('.grid-input-text');
                if (details) details.value = entry.comments || '';

                tbody.appendChild(newRow);
            });
        } else {
            tbody.appendChild(templateRow);
            resetTimesheetBoard();
        }

        setupRowEvents();
        calculateTotals();
    }

    function updateStatusBadge(text, classes) {
        const badge = document.getElementById('timesheetStatusBadge');
        if (badge) {
            badge.textContent = 'Status: ' + text;
            badge.className = `badge rounded-pill px-4 py-2 fw-bold shadow-sm ${classes}`;
        }
    }

    function resetTimesheetBoard() {
        const tbody = document.querySelector('.timecard-table tbody');
        const rows = tbody.querySelectorAll('tr');

        for(let i = 1; i < rows.length; i++) rows[i].remove();

        const firstRow = tbody.querySelector('tr');
        if(firstRow) {
            firstRow.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);
            const detailsInput = firstRow.querySelector('.grid-input-text');
            if(detailsInput) detailsInput.value = '';
        }

        const overallCommentsArea = document.getElementById('overallComments');
        if(overallCommentsArea) overallCommentsArea.value = '';

        setupRowEvents();
        calculateTotals();
    }

    function setupRowEvents() {
        document.querySelectorAll('.timecard-table tbody tr').forEach(row => {
            const selects = row.querySelectorAll('select');
            if (selects.length >= 2) {
                const projectSelect = selects[0];
                const taskSelect = selects[1];
                const inputs = row.querySelectorAll('.grid-input-hours');

                const checkLock = () => {
                    const isLocked = projectSelect.selectedIndex === 0 || taskSelect.selectedIndex === 0;
                    inputs.forEach(input => {
                        input.disabled = isLocked;
                        if (isLocked) {
                            input.value = '0';
                            input.style.backgroundColor = '#f1f5f9';
                            input.style.cursor = 'not-allowed';
                        } else {
                            input.style.backgroundColor = '';
                            input.style.cursor = 'text';
                        }
                    });
                    calculateTotals();
                };

                projectSelect.removeEventListener('change', checkLock);
                taskSelect.removeEventListener('change', checkLock);
                projectSelect.addEventListener('change', checkLock);
                taskSelect.addEventListener('change', checkLock);
                checkLock();
            }

            const deleteBtn = row.querySelector('.btn-delete-row');
            if(deleteBtn) {
                deleteBtn.removeEventListener('click', deleteRow);
                deleteBtn.addEventListener('click', deleteRow);
            }

            row.querySelectorAll('.grid-input-hours').forEach(input => {
                input.removeEventListener('input', calculateTotals);
                input.addEventListener('input', calculateTotals);
            });
        });
    }

    function calculateTotals() {
        let dailyTotals = [0, 0, 0, 0, 0, 0, 0];
        let grandTotal = 0;

        document.querySelectorAll('.timecard-table tbody tr').forEach(row => {
            let rowTotal = 0;
            row.querySelectorAll('.grid-input-hours').forEach((input, index) => {
                const val = parseFloat(input.value) || 0;
                rowTotal += val;
                if(index < 7) dailyTotals[index] += val;
            });
            const rowTotalCell = row.querySelector('.col-total');
            if(rowTotalCell) rowTotalCell.textContent = rowTotal.toFixed(1);
            grandTotal += rowTotal;
        });

        const footerTotals = document.querySelectorAll('.timecard-table tfoot .total-val');
        dailyTotals.forEach((total, index) => {
            if(footerTotals[index]) footerTotals[index].textContent = total.toFixed(1);
        });
        if(footerTotals.length > 0) {
            footerTotals[footerTotals.length - 1].textContent = grandTotal.toFixed(1);
        }
    }

    function addRow() {
        const tbody = document.querySelector('.timecard-table tbody');
        const newRow = tbody.querySelector('tr').cloneNode(true);
        newRow.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);
        newRow.querySelectorAll('.grid-input-text').forEach(input => input.value = '');
        tbody.appendChild(newRow);
        setupRowEvents();
        calculateTotals();
    }

    function deleteRow(event) {
        const tbody = document.querySelector('.timecard-table tbody');
        if (tbody.querySelectorAll('tr').length > 1) {
            event.target.closest('tr').remove();
            calculateTotals();
        } else {
            alert("You must have at least one row in your timesheet.");
        }
    }

    function submitTimesheet(status) {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const overallComments = document.getElementById('overallComments')?.value || '';
        const footerTotals = document.querySelectorAll('.timecard-table tfoot .total-val');
        const grandTotal = footerTotals.length > 0 ? parseFloat(footerTotals[footerTotals.length - 1].textContent) : 0;

        const rowData = [];
        document.querySelectorAll('.timecard-table tbody tr').forEach(row => {
            const selects = row.querySelectorAll('select');
            const rowTotal = parseFloat(row.querySelector('.col-total').textContent) || 0;

            if (rowTotal > 0 && selects[0].selectedIndex > 0 && selects[1].selectedIndex > 0) {
                const inputs = row.querySelectorAll('.grid-input-hours');
                rowData.push({
                    projectId: selects[0].selectedIndex,
                    taskId: selects[1].selectedIndex,
                    type: selects[2].value,
                    sun: parseFloat(inputs[0].value) || 0,
                    mon: parseFloat(inputs[1].value) || 0,
                    tue: parseFloat(inputs[2].value) || 0,
                    wed: parseFloat(inputs[3].value) || 0,
                    thu: parseFloat(inputs[4].value) || 0,
                    fri: parseFloat(inputs[5].value) || 0,
                    sat: parseFloat(inputs[6].value) || 0,
                    rowTotal: rowTotal,
                    details: row.querySelector('.grid-input-text').value
                });
            }
        });

        if (rowData.length === 0 && status === 'SUBMITTED') {
            alert("You cannot submit an empty timesheet. Please select a project and enter hours.");
            return;
        }

        const payload = { weekStartDate: startDate, weekEndDate: endDate, status: status, overallComments: overallComments, totalWeekHours: grandTotal, rows: rowData };

        fetch('/api/weekly-timesheet/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                alert(data.message);
                if(status === 'SUBMITTED') {
                    resetTimesheetBoard();
                    window.location.href = '/employee/erp-timesheet';
                }
            } else {
                alert("Error saving timesheet: " + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("A network error occurred while submitting the timesheet.");
        });
    }

    function setupDateSelectors() {
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const loadWeekBtn = document.getElementById('loadWeekBtn');

        const today = new Date();
        const todayStr = today.getFullYear() + '-' +
                         String(today.getMonth() + 1).padStart(2, '0') + '-' +
                         String(today.getDate()).padStart(2, '0');

        if (startDateInput) {
            startDateInput.setAttribute('max', todayStr);

            startDateInput.addEventListener('change', function() {
                if (this.value) {
                    const fromDate = new Date(this.value);

                    if (fromDate > today) {
                        alert("Company Policy: You cannot create a timesheet for future dates.");
                        this.value = '';
                        if (endDateInput) endDateInput.value = '';
                        return;
                    }

                    const toDate = new Date(fromDate);
                    toDate.setDate(toDate.getDate() + 6);
                    if (endDateInput) {
                        endDateInput.value = `${toDate.getFullYear()}-${String(toDate.getMonth() + 1).padStart(2, '0')}-${String(toDate.getDate()).padStart(2, '0')}`;
                    }
                }
            });
        }

        if(loadWeekBtn) {
            loadWeekBtn.addEventListener('click', function() {
                if(!startDateInput.value) return alert("Please select a valid start date first.");
                const startDate = new Date(startDateInput.value);

                if (startDate > today) {
                    return alert("Cannot load future weeks.");
                }
                const dayHeaders = document.querySelectorAll('.timecard-table th.col-day');
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

                for(let i = 0; i < 7; i++) {
                    const currentDate = new Date(startDate);
                    currentDate.setDate(currentDate.getDate() + i);
                    if(dayHeaders[i]) {
                        dayHeaders[i].innerHTML = `${dayNames[currentDate.getDay()]}<br><small class="text-secondary fw-bold text-capitalize">${currentDate.getDate()} ${monthNames[currentDate.getMonth()]}</small>`;
                    }
                }

                loadTimesheetForWeek(startDateInput.value);
            });
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>