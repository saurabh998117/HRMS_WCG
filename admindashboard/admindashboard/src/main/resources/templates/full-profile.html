<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Profile | WhiteCircle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --navy: #1e3a8a; --light-blue: #f0f4f8; --border-color: #e2e8f0; }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-top: 100px; }

        .master-nav {
            position: fixed; top: 0; left: 0; right: 0; height: 85px; background: white;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px; z-index: 1000; border-bottom: 2px solid var(--navy);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .progress-container { width: 250px; margin-right: 20px; text-align: right; }
        .progress { height: 8px; border-radius: 10px; background: #e2e8f0; margin-top: 4px; }
        .progress-bar { background: var(--navy); transition: width 0.5s ease; }

        /* Card Styles */
        .section-card { background: white; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 24px; overflow: hidden; }
        .section-header { background: var(--navy); color: white; padding: 12px 20px; font-weight: 600; font-size: 0.9rem; letter-spacing: 0.5px; }
        .section-body { padding: 20px; }

        /* Field Styles */
        .info-box { background: #fdfdfd; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px 15px; margin-bottom: 15px; height: 100%; min-height: 65px; }
        .info-label { color: #94a3b8; font-size: 0.75rem; font-weight: 600; margin-bottom: 4px; display: block; }
        .info-value { color: #1e293b; font-size: 0.95rem; font-weight: 500; word-break: break-word; min-height: 20px; }

        /* Edit Mode Styles */
        .editable-field { display: none; width: 100%; border: 1px solid #3b82f6; border-radius: 4px; padding: 4px 8px; font-size: 0.9rem; }
        /* Only show editable fields inside cards marked as editable-card when in editing mode */
        .editing .editable-card .editable-field { display: block; }
        .editing .editable-card .info-value-text { display: none; }

        /* UPDATED: Changed from yellow to light gray/blue for a cleaner look */
        .bg-pending { background-color: #f1f5f9 !important; border-color: #cbd5e1 !important; }

        /* Header Card Specifics */
        .profile-main-card { background: white; border-radius: 15px; border: 1px solid #d1d5db; border-left: 8px solid var(--navy); padding: 25px; margin-bottom: 30px; }
        .avatar-circle { width: 90px; height: 90px; background: var(--navy); color: white; font-size: 2.2rem; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; }

        .info-value-text:empty::before { content: "\200b"; }

        /* UPDATED: Back Button Style */
        .btn-back { background-color: var(--navy); color: white; font-weight: 600; padding: 8px 20px; border-radius: 50px; text-decoration: none; display: flex; align-items: center; transition: background 0.2s; }
        .btn-back:hover { background-color: #162c6b; color: white; }
    </style>
</head>
<body>

<nav class="master-nav">
    <div class="d-flex align-items-center">
        <img src="/images/wcg-logo.jpg" alt="Logo" height="65" class="me-3">
        <h4 class="fw-bold m-0" style="color: var(--navy)">MASTER PROFILE PAGE</h4>
    </div>

    <div class="d-flex align-items-center">
        <div class="progress-container d-none d-lg-block">
            <span class="small fw-bold text-muted">Profile: <span id="percentLabel" class="text-primary">0%</span> Complete</span>
            <div class="progress"><div class="progress-bar" id="completionBar" style="width: 0%"></div></div>
        </div>
        <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" id="editToggleBtn" onclick="toggleEditMode()">
            <i class="fas fa-user-edit me-2"></i>Complete Profile
        </button>
        <a th:href="@{/my-whitecircle}" class="btn-back ms-3">
            <i class="fas fa-arrow-left me-2"></i> Back to My WhiteCircle
        </a>
    </div>
</nav>

<div class="container-fluid px-4 px-lg-5">

    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show fw-bold shadow-sm" role="alert">
        <i class="fas fa-check-circle me-2"></i> <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <form id="masterProfileForm" th:action="@{/employee/profile/save-detailed}" method="POST">

        <div class="profile-main-card d-flex align-items-center flex-wrap">
            <div class="avatar-circle me-4">
                <span th:text="${user.fullName != null ? user.fullName.substring(0,1) : ''}"></span>
            </div>
            <div class="flex-grow-1">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="info-label">Employee Name</label>
                        <div class="info-value fw-bold text-primary" th:text="${user.fullName}"></div>
                    </div>
                    <div class="col-md-3">
                        <label class="info-label">Employee ID</label>
                        <div class="info-value" th:text="${user.username}"></div>
                    </div>
                    <div class="col-md-3">
                        <label class="info-label">Designation</label>
                        <div class="info-value" th:text="${user.designation}"></div>
                    </div>
                    <div class="col-md-3">
                        <label class="info-label">Official Email</label>
                        <div class="info-value" th:text="${user.email}"></div>
                    </div>
                </div>
            </div>
            <div class="ms-auto mt-3 mt-lg-0"><span class="badge bg-success px-3 py-2">Active</span></div>
        </div>

        <div class="row">
            <div class="col-lg-8">

                <div class="section-card editable-card">
                    <div class="section-header"><i class="fas fa-user-cog me-2"></i> PERSONAL DETAILS</div>
                    <div class="section-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Mobile Number</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.mobileNumber}"></span>
                                        <input type="text" name="mobileNumber" class="editable-field" th:value="${user.mobileNumber}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Personal Email</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.personalEmail}"></span>
                                        <input type="email" name="personalEmail" class="editable-field" th:value="${user.employeeProfile?.personalEmail}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Gender</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.gender}"></span>
                                        <select name="gender" class="editable-field">
                                            <option value="">Select Gender</option>
                                            <option value="Male" th:selected="${user.employeeProfile?.gender == 'Male'}">Male</option>
                                            <option value="Female" th:selected="${user.employeeProfile?.gender == 'Female'}">Female</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Date of Birth</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.dob}"></span>
                                        <input type="date" name="dob" class="editable-field" th:value="${user.employeeProfile?.dob}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Aadhar Card No.</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.aadharNo}"></span>
                                        <input type="text" name="aadharNo" class="editable-field" th:value="${user.employeeProfile?.aadharNo}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">PAN Card No.</label>
                                    <div class="info-value">
                                        <span class="info-value-text text-uppercase" th:text="${user.employeeProfile?.panNo}"></span>
                                        <input type="text" name="panNo" class="editable-field text-uppercase" th:value="${user.employeeProfile?.panNo}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-box">
                                    <label class="info-label">Permanent Address</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.permanentAddress}"></span>
                                        <textarea name="permanentAddress" class="editable-field" rows="2" th:text="${user.employeeProfile?.permanentAddress}"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header"><i class="fas fa-project-diagram me-2"></i> PROJECT & ALLOCATION</div>
                    <div class="section-body">
                        <div class="row g-3">
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Business Unit</label><div class="info-value" th:text="${user.businessUnit}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Account Name</label><div class="info-value" th:text="${user.accountName}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Project Name</label><div class="info-value" th:text="${user.projectName}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Project Code</label><div class="info-value" th:text="${user.projectCode}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Team / Group</label><div class="info-value" th:text="${user.teamGroup}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Vertical Name</label><div class="info-value" th:text="${user.verticalName}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Customer Name</label><div class="info-value" th:text="${user.customerName}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Domain / Industry</label><div class="info-value" th:text="${user.domainIndustry}"></div></div></div>
                        </div>
                    </div>
                </div>

                <div class="section-card editable-card">
                    <div class="section-header"><i class="fas fa-graduation-cap me-2"></i> EDUCATIONAL DETAILS</div>
                    <div class="section-body">
                        <h6 class="text-primary mb-3" style="font-size: 0.85rem; font-weight: 600;">Highest Qualification</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><div class="info-box"><label class="info-label">Degree / Course</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual1Title}"></span><input type="text" name="qual1Title" class="editable-field" th:value="${user.employeeProfile?.qual1Title}"></div></div></div>
                            <div class="col-md-5"><div class="info-box"><label class="info-label">University / Board</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual1Inst}"></span><input type="text" name="qual1Inst" class="editable-field" th:value="${user.employeeProfile?.qual1Inst}"></div></div></div>
                            <div class="col-md-3"><div class="info-box"><label class="info-label">Passing Year</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual1Year}"></span><input type="text" name="qual1Year" class="editable-field" th:value="${user.employeeProfile?.qual1Year}"></div></div></div>
                        </div>

                        <h6 class="text-primary mb-3" style="font-size: 0.85rem; font-weight: 600;">Secondary Qualification</h6>
                        <div class="row g-3">
                            <div class="col-md-4"><div class="info-box"><label class="info-label">Degree / Course</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual2Title}"></span><input type="text" name="qual2Title" class="editable-field" th:value="${user.employeeProfile?.qual2Title}"></div></div></div>
                            <div class="col-md-5"><div class="info-box"><label class="info-label">University / Board</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual2Inst}"></span><input type="text" name="qual2Inst" class="editable-field" th:value="${user.employeeProfile?.qual2Inst}"></div></div></div>
                            <div class="col-md-3"><div class="info-box"><label class="info-label">Passing Year</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual2Year}"></span><input type="text" name="qual2Year" class="editable-field" th:value="${user.employeeProfile?.qual2Year}"></div></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">

                <div class="section-card editable-card">
                    <div class="section-header"><i class="fas fa-briefcase me-2"></i> WORK DETAILS</div>
                    <div class="section-body">
                        <div class="info-box mb-3">
                            <label class="info-label">Date of Joining</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.joiningDate}"></span>
                                <input type="date" name="joiningDate" class="editable-field" th:value="${user.joiningDate}">
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <label class="info-label">Experience</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.experience}"></span>
                                <input type="text" name="experience" class="editable-field" th:value="${user.experience}">
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <label class="info-label">Work Location / Address</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.workingAddress}"></span>
                                <textarea name="workingAddress" class="editable-field" rows="2" th:text="${user.employeeProfile?.workingAddress}"></textarea>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="info-box">
                                    <label class="info-label">City</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.city}"></span>
                                        <input type="text" name="city" class="editable-field" th:value="${user.city}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-box">
                                    <label class="info-label">State/Country</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.country}"></span>
                                        <input type="text" name="country" class="editable-field" th:value="${user.country}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header"><i class="fas fa-users-cog me-2"></i> REPORTING LINES</div>
                    <div class="section-body">
                        <div class="info-box mb-3"><label class="info-label">Reporting Manager</label><div class="info-value" th:text="${user.reportingManager}"></div></div>
                        <div class="info-box mb-3"><label class="info-label">Project Manager</label><div class="info-value" th:text="${user.projectManager}"></div></div>
                        <div class="info-box"><label class="info-label">BU-HR Contact</label><div class="info-value" th:text="${user.buHrContact}"></div></div>
                    </div>
                </div>

                <div class="section-card border-danger editable-card">
                    <div class="section-header bg-danger"><i class="fas fa-ambulance me-2"></i> EMERGENCY CONTACT DETAILS</div>
                    <div class="section-body">
                        <div class="info-box mb-3">
                            <label class="info-label">Emergency Contact Person</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.emergencyContactName}"></span>
                                <input type="text" name="emergencyContactName" class="editable-field" th:value="${user.employeeProfile?.emergencyContactName}">
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <label class="info-label">Relation with Employee</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.relationWithEmployee}"></span>
                                <input type="text" name="relationWithEmployee" class="editable-field" th:value="${user.employeeProfile?.relationWithEmployee}">
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <label class="info-label">Emergency Phone</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.emergencyPhone}"></span>
                                <input type="text" name="emergencyPhone" class="editable-field" th:value="${user.employeeProfile?.emergencyPhone}">
                            </div>
                        </div>
                        <div class="info-box">
                            <label class="info-label">Alternate Mobile No.</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.altMobile}"></span>
                                <input type="text" name="altMobile" class="editable-field" th:value="${user.employeeProfile?.altMobile}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function toggleEditMode() {
        const body = document.body;
        const btn = document.getElementById('editToggleBtn');

        if (!body.classList.contains('editing')) {
            // Enter Edit Mode
            body.classList.add('editing');
            btn.innerHTML = '<i class="fas fa-save me-2"></i>Save Master Profile';
            btn.className = "btn btn-success rounded-pill px-4 fw-bold shadow";

            // Highlight empty fields with the new gray/blue color
            document.querySelectorAll('.editable-card .info-value-text').forEach(span => {
                if (span.innerText.trim() === "") {
                    span.closest('.info-box').classList.add('bg-pending');
                }
            });
        } else {
            // Submit the Form
            document.getElementById('masterProfileForm').submit();
        }
    }

    function calculateCompletion() {
        // Only target fields that are inside editable cards
        const textFields = document.querySelectorAll('.editable-card .info-value-text');
        if (textFields.length === 0) return;

        let filled = 0;
        textFields.forEach(f => {
            if(f.innerText.trim() !== "") {
                filled++;
            }
        });

        let percent = Math.round((filled / textFields.length) * 100);
        document.getElementById('completionBar').style.width = percent + '%';
        document.getElementById('percentLabel').innerText = percent + '%';

        if(percent === 100) {
             document.getElementById('completionBar').classList.replace('bg-primary', 'bg-success');
        } else {
             document.getElementById('completionBar').classList.replace('bg-success', 'bg-primary');
        }
    }
    window.onload = calculateCompletion;
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>