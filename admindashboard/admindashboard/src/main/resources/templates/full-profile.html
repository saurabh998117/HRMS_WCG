<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Profile | WhiteCircle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --navy: #1e3a8a;
            --navy-hover: #172a6b;
            --light-blue: #f0f4f8;
            --border-color: #e2e8f0;
            --bg-color: #f4f7f9; /* Slightly richer off-white for depth */
            --text-main: #0f172a;
            --text-muted: #64748b;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --card-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }

        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-top: 120px;
            letter-spacing: -0.01em; /* Modern typography touch */
        }

        /* Glassmorphism Navbar (Premium Blur Effect) */
        .master-nav {
            position: fixed; top: 0; left: 0; right: 0; height: 85px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 40px; z-index: 1000;
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }

        /* Progress Bar Enhancements */
        .progress-container { width: 260px; margin-right: 25px; text-align: right; }
        .progress-track {
            width: 160px; height: 8px; /* Slimmer, sleeker */
            background-color: #e2e8f0; border-radius: 20px;
            overflow: hidden; float: right; margin-top: 6px;
        }
        .progress-fill {
            height: 100%; border-radius: 20px;
            background: linear-gradient(90deg, var(--navy) 0%, #3b82f6 100%);
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1), background 0.5s ease;
        }

        /* Modern Card Design */
        .section-card {
            background: white; border-radius: 16px;
            border: 1px solid var(--border-color); margin-bottom: 24px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s ease;
            overflow: hidden; /* <-- THIS FIXES THE CORNER OVERLAP */
        }
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--card-shadow-hover);
        }

        .section-header {
            background: var(--navy); color: white;
            padding: 16px 20px; font-weight: 600; font-size: 0.95rem;
            letter-spacing: 0.5px; border-bottom: none;
            display: flex; align-items: center; text-transform: uppercase;
        }
        /* Make the icons light blue so they pop against the dark navy background */
        .section-header i { color: #93c5fd; margin-right: 12px; font-size: 1.15rem; }

        .section-body { padding: 20px; }

        /* Header Main Card - Premium Gradient */
        .profile-main-card {
            background: linear-gradient(to right, #ffffff, #f8fafc);
            border-radius: 16px; border: 1px solid #e2e8f0;
            border-left: 6px solid var(--navy); padding: 30px; margin-bottom: 30px;
            box-shadow: var(--card-shadow); transition: all 0.3s ease;
        }
        .profile-main-card:hover { transform: translateY(-2px); box-shadow: var(--card-shadow-hover); }

        /* Avatar Enhancements */
        .avatar-circle {
            width: 95px; height: 95px;
            background: linear-gradient(135deg, var(--navy) 0%, #3b82f6 100%);
            color: white; font-size: 2.5rem; display: flex; align-items: center;
            justify-content: center; border-radius: 50%; font-weight: 700;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            border: 4px solid white;
        }

        /* Information Grid Boxes - Soft & Interactive */
        .info-box {
            background: #fdfdfd; border: 1px solid #f8fafc;
            border-radius: 10px; padding: 12px 16px; margin-bottom: 12px;
            height: 100%; min-height: 70px; transition: all 0.2s ease;
        }
        .info-box:hover { background: #f8fafc; border-color: #e2e8f0; }

        /* Professional Typography for Labels/Values */
        .info-label { color: var(--text-muted); font-size: 0.72rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 6px; display: block; }
        .info-value { color: var(--text-main); font-size: 0.95rem; font-weight: 500; word-break: break-word; }

        /* Edit Mode Input Styling (SaaS style) */
        .editable-field {
            display: none; width: 100%;
            border: 1px solid #cbd5e1; border-radius: 6px;
            padding: 8px 12px; font-size: 0.95rem; color: var(--text-main);
            transition: border-color 0.2s, box-shadow 0.2s;
            background-color: #fff;
        }
        .editable-field:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .editing .editable-card .editable-field { display: block; }
        .editing .editable-card .info-value-text { display: none; }

        /* Highlight missing fields with a subtle left-border indicator */
        .bg-pending { background-color: #f8fafc !important; border-left: 3px solid #94a3b8 !important; }
        .info-value-text:empty::before { content: "\200b"; }

        /* Button Enhancements */
        .btn-primary { background: var(--navy); border: none; box-shadow: 0 4px 6px -1px rgba(30, 58, 138, 0.2); transition: all 0.2s; }
        .btn-primary:hover { background: var(--navy-hover); transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(30, 58, 138, 0.3); }

        .btn-success { background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%); border: none; box-shadow: 0 4px 6px -1px rgba(22, 163, 74, 0.2); }
        .btn-success:hover { background: linear-gradient(135deg, #15803d 0%, #16a34a 100%); transform: translateY(-1px); }

        /* Sleeker Back Button - Restored to Solid Navy */
        .btn-back {
            background-color: var(--navy); color: white;
            font-weight: 600; padding: 8px 20px; border-radius: 10px;
            border: none; text-decoration: none; display: flex;
            align-items: center; transition: all 0.2s; box-shadow: 0 2px 4px rgba(30, 58, 138, 0.2);
        }
        .btn-back:hover {
            background-color: var(--navy-hover); color: white;
            transform: translateY(-1px); box-shadow: 0 4px 6px rgba(30, 58, 138, 0.3);
        }

        /* Modern Status Badge */
        .badge.bg-success { background-color: #dcfce7 !important; color: #166534 !important; font-weight: 700; padding: 0.6em 1.2em; border-radius: 8px; border: 1px solid #bbf7d0; }
    </style>
</head>
<body>

<nav class="master-nav">
    <div class="d-flex align-items-center">
        <img src="/images/wcg-logo.jpg" alt="Logo" height="65" class="me-3">
        <h4 class="fw-bold m-0" style="color: var(--navy)">MY PROFILE PAGE</h4>
    </div>

    <div class="d-flex align-items-center">
        <div class="progress-container d-none d-lg-block">
            <span class="small fw-bold text-muted d-block mb-1">Profile: <span id="percentLabel" class="text-primary">0%</span> Complete</span>
            <div class="progress-track"><div class="progress-fill" id="completionBar" style="width: 0%"></div></div>
        </div>
        <button type="button" class="btn btn-primary rounded-pill px-4 fw-bold shadow-sm" id="editToggleBtn" onclick="toggleEditMode()">
            <i class="fas fa-user-edit me-2"></i>Complete Profile
        </button>
        <a th:href="@{/my-whitecircle}" class="btn-back ms-3">
            <i class="fas fa-arrow-left me-2"></i> Back to My WhiteCircle
        </a>
    </div>
</nav>

<div class="container-fluid px-4 px-lg-5">

    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show fw-bold shadow-sm" role="alert">
        <i class="fas fa-check-circle me-2"></i> <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <form id="masterProfileForm" th:action="@{/employee/profile/save-detailed}" method="POST">

        <div class="profile-main-card d-flex align-items-center flex-wrap">
            <div class="avatar-circle me-4">
                <span th:text="${user.fullName != null ? user.fullName.substring(0,1) : ''}"></span>
            </div>
            <div class="flex-grow-1">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="info-label">Employee Name</label>
                        <div class="info-value fw-bold text-primary" th:text="${user.fullName}"></div>
                    </div>
                    <div class="col-md-3">
                        <label class="info-label">Employee ID</label>
                        <div class="info-value" th:text="${user.username}"></div>
                    </div>
                    <div class="col-md-3">
                        <label class="info-label">Designation</label>
                        <div class="info-value" th:text="${user.designation}"></div>
                    </div>
                    <div class="col-md-3">
                        <label class="info-label">Official Email</label>
                        <div class="info-value" th:text="${user.email}"></div>
                    </div>
                </div>
            </div>
            <div class="ms-auto mt-3 mt-lg-0"><span class="badge bg-success px-3 py-2">Active</span></div>
        </div>

        <div class="row">
            <div class="col-lg-8">

                <div class="section-card editable-card">
                    <div class="section-header"><i class="fas fa-user-cog me-2"></i> PERSONAL DETAILS</div>
                    <div class="section-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Mobile Number</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.mobileNumber}"></span>
                                        <input type="text" name="mobileNumber" class="editable-field" th:value="${user.mobileNumber}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Personal Email</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.personalEmail}"></span>
                                        <input type="email" name="personalEmail" class="editable-field"
                                               th:value="${user.employeeProfile?.personalEmail}"
                                               pattern=".*@gmail\.com$"
                                               title="Email must end with @gmail.com">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Gender</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.gender}"></span>
                                        <select name="gender" class="editable-field">
                                            <option value="">Select Gender</option>
                                            <option value="Male" th:selected="${user.employeeProfile?.gender == 'Male'}">Male</option>
                                            <option value="Female" th:selected="${user.employeeProfile?.gender == 'Female'}">Female</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Date of Birth</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.dob}"></span>
                                        <input type="date" name="dob" class="editable-field" th:value="${user.employeeProfile?.dob}" max="9999-12-31">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">Aadhar Card No.</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.aadharNo}"></span>
                                        <input type="text" name="aadharNo" class="editable-field"
                                               th:value="${user.employeeProfile?.aadharNo}"
                                               pattern="\d{12}" maxlength="12"
                                               title="Aadhar Card must be exactly 12 digits (e.g., 123456789012)">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-box">
                                    <label class="info-label">PAN Card No.</label>
                                    <div class="info-value">
                                        <span class="info-value-text text-uppercase" th:text="${user.employeeProfile?.panNo}"></span>
                                        <input type="text" name="panNo" class="editable-field text-uppercase"
                                               th:value="${user.employeeProfile?.panNo}"
                                               pattern="[A-Za-z]{5}[0-9]{4}[A-Za-z]{1}" maxlength="10"
                                               title="PAN must be 5 letters, 4 digits, 1 letter (e.g., ABCDE1234F)">
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-box">
                                    <label class="info-label">Permanent Address</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.employeeProfile?.permanentAddress}"></span>
                                        <textarea name="permanentAddress" class="editable-field" rows="2" th:text="${user.employeeProfile?.permanentAddress}"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header"><i class="fas fa-project-diagram me-2"></i> PROJECT & ALLOCATION</div>
                    <div class="section-body">
                        <div class="row g-3">
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Business Unit</label><div class="info-value" th:text="${user.businessUnit}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Account Name</label><div class="info-value" th:text="${user.accountName}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Project Name</label><div class="info-value" th:text="${user.projectName}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Project Code</label><div class="info-value" th:text="${user.projectCode}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Team / Group</label><div class="info-value" th:text="${user.teamGroup}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Vertical Name</label><div class="info-value" th:text="${user.verticalName}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Customer Name</label><div class="info-value" th:text="${user.customerName}"></div></div></div>
                            <div class="col-md-6"><div class="info-box"><label class="info-label">Domain / Industry</label><div class="info-value" th:text="${user.domainIndustry}"></div></div></div>
                        </div>
                    </div>
                </div>

                <div class="section-card editable-card">
                    <div class="section-header"><i class="fas fa-graduation-cap me-2"></i> EDUCATIONAL DETAILS</div>
                    <div class="section-body">
                        <h6 class="text-primary mb-3" style="font-size: 0.85rem; font-weight: 600;">Highest Qualification</h6>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><div class="info-box"><label class="info-label">Degree / Course</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual1Title}"></span><input type="text" name="qual1Title" class="editable-field" th:value="${user.employeeProfile?.qual1Title}"></div></div></div>
                            <div class="col-md-5"><div class="info-box"><label class="info-label">University / Board</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual1Inst}"></span><input type="text" name="qual1Inst" class="editable-field" th:value="${user.employeeProfile?.qual1Inst}"></div></div></div>
                            <div class="col-md-3"><div class="info-box"><label class="info-label">Passing Year</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual1Year}"></span><input type="text" name="qual1Year" class="editable-field" th:value="${user.employeeProfile?.qual1Year}"></div></div></div>
                        </div>

                        <h6 class="text-primary mb-3" style="font-size: 0.85rem; font-weight: 600;">Secondary Qualification</h6>
                        <div class="row g-3">
                            <div class="col-md-4"><div class="info-box"><label class="info-label">Degree / Course</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual2Title}"></span><input type="text" name="qual2Title" class="editable-field" th:value="${user.employeeProfile?.qual2Title}"></div></div></div>
                            <div class="col-md-5"><div class="info-box"><label class="info-label">University / Board</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual2Inst}"></span><input type="text" name="qual2Inst" class="editable-field" th:value="${user.employeeProfile?.qual2Inst}"></div></div></div>
                            <div class="col-md-3"><div class="info-box"><label class="info-label">Passing Year</label><div class="info-value"><span class="info-value-text" th:text="${user.employeeProfile?.qual2Year}"></span><input type="text" name="qual2Year" class="editable-field" th:value="${user.employeeProfile?.qual2Year}"></div></div></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="section-card editable-card">
                    <div class="section-header"><i class="fas fa-briefcase me-2"></i> WORK DETAILS</div>
                    <div class="section-body">
                        <div class="info-box mb-3">
                            <label class="info-label">Date of Joining</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.joiningDate}"></span>
                                <input type="date" name="joiningDate" class="editable-field" th:value="${user.joiningDate}" max="9999-12-31">
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <label class="info-label">Experience</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.experience}"></span>
                                <input type="text" name="experience" class="editable-field" th:value="${user.experience}">
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <label class="info-label">Work Location / Address</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.workingAddress}"></span>
                                <textarea name="workingAddress" class="editable-field" rows="2" th:text="${user.employeeProfile?.workingAddress}"></textarea>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="info-box">
                                    <label class="info-label">City</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.city}"></span>
                                        <input type="text" name="city" class="editable-field" th:value="${user.city}" placeholder="e.g., Nagpur">
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="info-box">
                                    <label class="info-label">State/Country</label>
                                    <div class="info-value">
                                        <span class="info-value-text" th:text="${user.country}"></span>
                                        <input type="text" name="country" class="editable-field" th:value="${user.country}" placeholder="e.g., Maharashtra, India">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header"><i class="fas fa-users-cog me-2"></i> REPORTING LINES</div>
                    <div class="section-body">
                        <div class="info-box mb-3"><label class="info-label">Reporting Manager</label><div class="info-value" th:text="${user.reportingManager}"></div></div>
                        <div class="info-box mb-3"><label class="info-label">Project Manager</label><div class="info-value" th:text="${user.projectManager}"></div></div>
                        <div class="info-box"><label class="info-label">BU-HR Contact</label><div class="info-value" th:text="${user.buHrContact}"></div></div>
                    </div>
                </div>

                <div class="section-card border-danger editable-card">
                    <div class="section-header bg-danger"><i class="fas fa-ambulance me-2"></i> EMERGENCY CONTACT DETAILS</div>
                    <div class="section-body">
                        <div class="info-box mb-3">
                            <label class="info-label">Emergency Contact Person</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.emergencyContactName}"></span>
                                <input type="text" name="emergencyContactName" class="editable-field" th:value="${user.employeeProfile?.emergencyContactName}">
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <label class="info-label">Relation with Employee</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.relationWithEmployee}"></span>
                                <input type="text" name="relationWithEmployee" class="editable-field" th:value="${user.employeeProfile?.relationWithEmployee}">
                            </div>
                        </div>
                        <div class="info-box mb-3">
                            <label class="info-label">Emergency Phone</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.emergencyPhone}"></span>
                                <input type="text" name="emergencyPhone" class="editable-field" th:value="${user.employeeProfile?.emergencyPhone}">
                            </div>
                        </div>
                        <div class="info-box">
                            <label class="info-label">Alternate Mobile No.</label>
                            <div class="info-value">
                                <span class="info-value-text" th:text="${user.employeeProfile?.altMobile}"></span>
                                <input type="text" name="altMobile" class="editable-field" th:value="${user.employeeProfile?.altMobile}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function toggleEditMode() {
        const body = document.body;
        const btn = document.getElementById('editToggleBtn');
        const form = document.getElementById('masterProfileForm');

        if (!body.classList.contains('editing')) {
            // Enter Edit Mode
            body.classList.add('editing');
            btn.innerHTML = '<i class="fas fa-save me-2"></i>Save Master Profile';
            btn.className = "btn btn-success rounded-pill px-4 fw-bold shadow";

            // Highlight empty fields
            document.querySelectorAll('.editable-card .info-value-text').forEach(span => {
                if (span.innerText.trim() === "") {
                    span.closest('.info-box').classList.add('bg-pending');
                }
            });
        } else {
            // reportValidity() triggers the red HTML error popups if pattern rules fail
            if (form.reportValidity()) {
                form.submit();
            }
        }
    }

    function calculateCompletion() {
        const textFields = document.querySelectorAll('.editable-card .info-value-text');
        if (textFields.length === 0) return;

        let filled = 0;
        textFields.forEach(f => {
            if(f.innerText.trim() !== "") filled++;
        });

        let percent = Math.round((filled / textFields.length) * 100);
        const bar = document.getElementById('completionBar');
        const label = document.getElementById('percentLabel');

        bar.style.width = percent + '%';
        label.innerText = percent + '%';

        if(percent === 100) {
             bar.style.background = 'linear-gradient(90deg, #166534 0%, #22c55e 100%)';
             label.classList.replace('text-primary', 'text-success');
        }
    }

    // Run when page loads
    window.onload = function() {
        calculateCompletion();
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>